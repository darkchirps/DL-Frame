"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.xlsxToJson = xlsxToJson;
// excel-to-json.ts
const fs = require("fs");
const path = require("path");
const xlsx = require("xlsx");
const yasuo = true; // JSON压缩选项
function xlsxToJson(excelPath, outputDir) {
    // 确保输出目录存在
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }
    const files = fs.readdirSync(excelPath);
    const generatedFiles = [];
    const typeInfos = [];
    // 类型转换函数
    const convertValue = (type, value) => {
        if (value === undefined || value === null || value === '') {
            if (type.startsWith('array1'))
                return [];
            if (type.startsWith('array2'))
                return [];
            if (type.startsWith('kv'))
                return {};
            if (type === 'int')
                return 0;
            return '';
        }
        const typeLower = type.toLowerCase();
        const valueStr = value.toString().trim();
        // 处理一维数组类型
        if (typeLower.startsWith('array1<')) {
            const match = typeLower.match(/array1<([^>]+)>/);
            if (!match)
                return [];
            const inner = match[1];
            if (!valueStr)
                return [];
            return valueStr.split(',').map(v => convertValue(inner, v.trim()));
        }
        // 处理二维数组类型
        if (typeLower.startsWith('array2<')) {
            const match = typeLower.match(/array2<([^>]+)>/);
            if (!match)
                return [];
            const inner = match[1];
            if (!valueStr)
                return [];
            if (valueStr.includes(';') || valueStr.includes('|')) {
                const sep = valueStr.includes(';') ? ';' : '|';
                return valueStr.split(sep).map(row => row.split(',').map(v => convertValue(inner, v.trim())));
            }
            if (valueStr.includes(',')) {
                return [valueStr.split(',').map(v => convertValue(inner, v.trim()))];
            }
            return [[convertValue(inner, valueStr)]];
        }
        // 处理kv类型
        if (typeLower.startsWith('kv<')) {
            const match = typeLower.match(/kv<([^>]+)>/);
            if (!match)
                return {};
            const inner = match[1];
            const kvPairs = valueStr.split(',');
            const result = {};
            kvPairs.forEach(pair => {
                const [key, val] = pair.split(':').map(s => s.trim());
                if (key && val !== undefined) {
                    result[key] = convertValue(inner, val);
                }
            });
            return result;
        }
        // 基本类型处理
        switch (typeLower) {
            case 'int':
                return Number.isInteger(value) ? value : parseInt(valueStr, 10) || 0;
            case 'string':
                return valueStr;
            case 'array1': {
                if (!valueStr)
                    return [];
                return valueStr.split(',').map(item => {
                    const trimmed = item.trim();
                    const numVal = parseFloat(trimmed);
                    return isNaN(numVal) ? trimmed : numVal;
                });
            }
            case 'array2': {
                if (!valueStr)
                    return [];
                if (valueStr.includes(';') || valueStr.includes('|')) {
                    const sep = valueStr.includes(';') ? ';' : '|';
                    return valueStr.split(sep).map(row => row.split(',').map(v => {
                        const trimmed = v.trim();
                        const numVal = parseFloat(trimmed);
                        return isNaN(numVal) ? trimmed : numVal;
                    }));
                }
                if (valueStr.includes(',')) {
                    return [valueStr.split(',').map(v => {
                            const trimmed = v.trim();
                            const numVal = parseFloat(trimmed);
                            return isNaN(numVal) ? trimmed : numVal;
                        })];
                }
                return [[value]];
            }
            case 'kv': {
                const result = {};
                valueStr.split(',').forEach(pair => {
                    const [key, val] = pair.split(':').map(s => s.trim());
                    if (key && val !== undefined) {
                        const numVal = parseFloat(val);
                        result[key] = isNaN(numVal) ? val : numVal;
                    }
                });
                return result;
            }
            default:
                return value;
        }
    };
    // 转换为TypeScript类型
    const convertToTsType = (type) => {
        if (!type)
            return 'any';
        const typeLower = type.toLowerCase();
        if (typeLower === 'int')
            return 'number';
        if (typeLower === 'string')
            return 'string';
        if (typeLower.startsWith('array1'))
            return 'any[]';
        if (typeLower.startsWith('array2'))
            return 'any[][]';
        if (typeLower.startsWith('kv'))
            return '{ [key: string]: any }';
        return 'any';
    };
    // 处理每个Excel文件
    files.forEach(file => {
        if (!/\.(xlsx|xls)$/i.test(path.extname(file)))
            return;
        const filePath = path.join(`${excelPath}`, `${file}`);
        const workbook = xlsx.readFile(filePath);
        // 处理每个工作表
        // @ts-ignore
        workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            const rows = xlsx.utils.sheet_to_json(worksheet, { header: 1 });
            if (!rows || rows.length === 0) {
                console.warn(`工作表 ${sheetName} 没有数据，跳过处理`);
                return;
            }
            let jsonData = null;
            let keys = [];
            let types = [];
            let fieldComments = [];
            // 判断表格格式：竖式或横式
            if (rows[0][0] === 'id' || rows[0][0] === 'lid') {
                // 竖式表格
                if (rows.length < 4) {
                    console.warn(`工作表 ${sheetName} 数据不足，跳过处理`);
                    return;
                }
                keys = rows[0];
                types = rows[1].map((t) => t ? t.toString().toLowerCase() : 'string');
                fieldComments = rows[2].map((c) => c ? c.toString() : '');
                jsonData = [];
                for (let i = 3; i < rows.length; i++) {
                    const row = rows[i];
                    const obj = {};
                    if (row[0] !== undefined) {
                        for (let j = 0; j < keys.length; j++) {
                            obj[keys[j]] = convertValue(types[j], row[j]);
                        }
                        jsonData.push(obj);
                    }
                }
            }
            else {
                // 横式表格
                jsonData = {};
                keys = [];
                types = [];
                fieldComments = [];
                rows.forEach(row => {
                    if (row.length < 4)
                        return;
                    const key = row[0];
                    const type = row[1] ? row[1].toString().toLowerCase() : 'string';
                    const comment = row[2] ? row[2].toString() : '';
                    keys.push(key);
                    types.push(type);
                    fieldComments.push(comment);
                    const data = row.slice(3);
                    if (data.length === 1) {
                        jsonData[key] = convertValue(type, data[0]);
                    }
                    else {
                        jsonData[key] = data.map(v => convertValue(type, v));
                    }
                });
            }
            // 生成JSON文件
            const jsonFileName = `${sheetName}.json`;
            const jsonOutputFile = path.join(`${outputDir}`, `${jsonFileName}`);
            fs.writeFileSync(jsonOutputFile, JSON.stringify(jsonData, null, yasuo ? 0 : 2));
            generatedFiles.push(jsonOutputFile);
            console.log(`转换成功: ${sheetName}.json`);
            // 收集类型信息
            typeInfos.push({
                name: sheetName,
                fields: keys.map((key, index) => ({
                    key,
                    tsType: convertToTsType(types[index]),
                    comment: fieldComments[index] || ''
                }))
            });
        });
    });
    // 生成类型定义文件
    if (typeInfos.length > 0) {
        generateTypeDefinition(typeInfos);
    }
}
// 生成TypeScript类型定义文件
function generateTypeDefinition(list) {
    const lines = [];
    lines.push("// 自动生成的配置类型定义，请勿手动修改\n");
    lines.push("/** 通用配置查询接口 */");
    lines.push("interface ConfigFunc<T> {");
    lines.push("   get(value?: any, key?: string): T;");
    lines.push("   getAll(): T[];");
    lines.push("}\n");
    lines.push("interface configType {");
    list.forEach(info => {
        const key = info.name.charAt(0).toLowerCase() + info.name.slice(1);
        lines.push(`    ${key}?: ConfigFunc<${info.name}Config>;`);
    });
    lines.push("}\n");
    // 生成每个配置表的接口
    list.forEach(info => {
        lines.push(`interface ${info.name}Config {`);
        info.fields.forEach(field => {
            if (field.comment) {
                lines.push(`    /** ${field.comment} */`);
            }
            lines.push(`    ${field.key}?: ${field.tsType};`);
        });
        lines.push("}\n");
    });
    const outputFile = path.join(Editor.Project.path, "type_conf.d.ts");
    fs.writeFileSync(outputFile, lines.join("\n"));
    console.log("已生成类型定义文件: type_conf.d.ts");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieGxzeFRvSnNvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NvdXJjZS94bHN4VG9Kc29uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBa0JBLGdDQTZOQztBQS9PRCxtQkFBbUI7QUFDbkIsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM3QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFhN0IsTUFBTSxLQUFLLEdBQVksSUFBSSxDQUFDLENBQUMsV0FBVztBQUV4QyxTQUFnQixVQUFVLENBQUMsU0FBaUIsRUFBRSxTQUFpQjtJQUMzRCxXQUFXO0lBQ1gsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUM1QixFQUFFLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxNQUFNLEtBQUssR0FBYSxFQUFFLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2xELE1BQU0sY0FBYyxHQUFhLEVBQUUsQ0FBQztJQUNwQyxNQUFNLFNBQVMsR0FBcUIsRUFBRSxDQUFDO0lBRXZDLFNBQVM7SUFDVCxNQUFNLFlBQVksR0FBRyxDQUFDLElBQVksRUFBRSxLQUFVLEVBQU8sRUFBRTtRQUNuRCxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDeEQsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQztnQkFBRSxPQUFPLEVBQUUsQ0FBQztZQUN6QyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDO2dCQUFFLE9BQU8sRUFBRSxDQUFDO1lBQ3pDLElBQUksSUFB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LENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxpQkFBaUIsSUFBSSxDQUFDLElBQUksVUFBVSxDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFDLENBQUM7SUFDSCxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRWxCLGFBQWE7SUFDYixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2hCLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN4QixJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDaEIsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLEtBQUssQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDO1lBQzlDLENBQUM7WUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sS0FBSyxDQUFDLEdBQUcsTUFBTSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUN0RCxDQUFDLENBQUMsQ0FBQztRQUNILEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDcEUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUM3QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gZXhjZWwtdG8tanNvbi50c1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCB4bHN4ID0gcmVxdWlyZShcInhsc3hcIik7XHJcblxyXG5pbnRlcmZhY2UgQ29uZmlnRmllbGQge1xyXG4gICAga2V5OiBzdHJpbmc7XHJcbiAgICB0c1R5cGU6IHN0cmluZztcclxuICAgIGNvbW1lbnQ6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIENvbmZpZ1R5cGVJbmZvIHtcclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIGZpZWxkczogQ29uZmlnRmllbGRbXTtcclxufVxyXG5cclxuY29uc3QgeWFzdW86IGJvb2xlYW4gPSB0cnVlOyAvLyBKU09O5Y6L57yp6YCJ6aG5XHJcblxyXG5leHBvcnQgZnVuY3Rpb24geGxzeFRvSnNvbihleGNlbFBhdGg6IHN0cmluZywgb3V0cHV0RGlyOiBzdHJpbmcpIHtcclxuICAgIC8vIOehruS/nei+k+WHuuebruW9leWtmOWcqFxyXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKG91dHB1dERpcikpIHtcclxuICAgICAgICBmcy5ta2RpclN5bmMob3V0cHV0RGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaWxlczogc3RyaW5nW10gPSBmcy5yZWFkZGlyU3luYyhleGNlbFBhdGgpO1xyXG4gICAgY29uc3QgZ2VuZXJhdGVkRmlsZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBjb25zdCB0eXBlSW5mb3M6IENvbmZpZ1R5cGVJbmZvW10gPSBbXTtcclxuXHJcbiAgICAvLyDnsbvlnovovazmjaLlh73mlbBcclxuICAgIGNvbnN0IGNvbnZlcnRWYWx1ZSA9ICh0eXBlOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBhbnkgPT4ge1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSAnJykge1xyXG4gICAgICAgICAgICBpZiAodHlwZS5zdGFydHNXaXRoKCdhcnJheTEnKSkgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICBpZiAodHlwZS5zdGFydHNXaXRoKCdhcnJheTInKSkgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICBpZiAodHlwZS5zdGFydHNXaXRoKCdrdicpKSByZXR1cm4ge307XHJcbiAgICAgICAgICAgIGlmICh0eXBlID09PSAnaW50JykgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHR5cGVMb3dlcjogc3RyaW5nID0gdHlwZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlU3RyOiBzdHJpbmcgPSB2YWx1ZS50b1N0cmluZygpLnRyaW0oKTtcclxuXHJcbiAgICAgICAgLy8g5aSE55CG5LiA57u05pWw57uE57G75Z6LXHJcbiAgICAgICAgaWYgKHR5cGVMb3dlci5zdGFydHNXaXRoKCdhcnJheTE8JykpIHtcclxuICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSB0eXBlTG93ZXIubWF0Y2goL2FycmF5MTwoW14+XSspPi8pO1xyXG4gICAgICAgICAgICBpZiAoIW1hdGNoKSByZXR1cm4gW107XHJcbiAgICAgICAgICAgIGNvbnN0IGlubmVyOiBzdHJpbmcgPSBtYXRjaFsxXTtcclxuICAgICAgICAgICAgaWYgKCF2YWx1ZVN0cikgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWVTdHIuc3BsaXQoJywnKS5tYXAodiA9PiBjb252ZXJ0VmFsdWUoaW5uZXIsIHYudHJpbSgpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWkhOeQhuS6jOe7tOaVsOe7hOexu+Wei1xyXG4gICAgICAgIGlmICh0eXBlTG93ZXIuc3RhcnRzV2l0aCgnYXJyYXkyPCcpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gdHlwZUxvd2VyLm1hdGNoKC9hcnJheTI8KFtePl0rKT4vKTtcclxuICAgICAgICAgICAgaWYgKCFtYXRjaCkgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICBjb25zdCBpbm5lcjogc3RyaW5nID0gbWF0Y2hbMV07XHJcbiAgICAgICAgICAgIGlmICghdmFsdWVTdHIpIHJldHVybiBbXTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlU3RyLmluY2x1ZGVzKCc7JykgfHwgdmFsdWVTdHIuaW5jbHVkZXMoJ3wnKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VwID0gdmFsdWVTdHIuaW5jbHVkZXMoJzsnKSA/ICc7JyA6ICd8JztcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZVN0ci5zcGxpdChzZXApLm1hcChyb3cgPT5cclxuICAgICAgICAgICAgICAgICAgICByb3cuc3BsaXQoJywnKS5tYXAodiA9PiBjb252ZXJ0VmFsdWUoaW5uZXIsIHYudHJpbSgpKSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHZhbHVlU3RyLmluY2x1ZGVzKCcsJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbdmFsdWVTdHIuc3BsaXQoJywnKS5tYXAodiA9PiBjb252ZXJ0VmFsdWUoaW5uZXIsIHYudHJpbSgpKSldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBbW2NvbnZlcnRWYWx1ZShpbm5lciwgdmFsdWVTdHIpXV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWkhOeQhmt257G75Z6LXHJcbiAgICAgICAgaWYgKHR5cGVMb3dlci5zdGFydHNXaXRoKCdrdjwnKSkge1xyXG4gICAgICAgICAgICBjb25zdCBtYXRjaCA9IHR5cGVMb3dlci5tYXRjaCgva3Y8KFtePl0rKT4vKTtcclxuICAgICAgICAgICAgaWYgKCFtYXRjaCkgcmV0dXJuIHt9O1xyXG4gICAgICAgICAgICBjb25zdCBpbm5lcjogc3RyaW5nID0gbWF0Y2hbMV07XHJcbiAgICAgICAgICAgIGNvbnN0IGt2UGFpcnM6IHN0cmluZ1tdID0gdmFsdWVTdHIuc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XHJcbiAgICAgICAgICAgIGt2UGFpcnMuZm9yRWFjaChwYWlyID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IFtrZXksIHZhbF0gPSBwYWlyLnNwbGl0KCc6JykubWFwKHMgPT4gcy50cmltKCkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGtleSAmJiB2YWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gY29udmVydFZhbHVlKGlubmVyLCB2YWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOWfuuacrOexu+Wei+WkhOeQhlxyXG4gICAgICAgIHN3aXRjaCAodHlwZUxvd2VyKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ2ludCc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkgPyB2YWx1ZSA6IHBhcnNlSW50KHZhbHVlU3RyLCAxMCkgfHwgMDtcclxuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZVN0cjtcclxuICAgICAgICAgICAgY2FzZSAnYXJyYXkxJzoge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF2YWx1ZVN0cikgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlU3RyLnNwbGl0KCcsJykubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyaW1tZWQgPSBpdGVtLnRyaW0oKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBudW1WYWwgPSBwYXJzZUZsb2F0KHRyaW1tZWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihudW1WYWwpID8gdHJpbW1lZCA6IG51bVZhbDtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ2FycmF5Mic6IHtcclxuICAgICAgICAgICAgICAgIGlmICghdmFsdWVTdHIpIHJldHVybiBbXTtcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZVN0ci5pbmNsdWRlcygnOycpIHx8IHZhbHVlU3RyLmluY2x1ZGVzKCd8JykpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZXAgPSB2YWx1ZVN0ci5pbmNsdWRlcygnOycpID8gJzsnIDogJ3wnO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZVN0ci5zcGxpdChzZXApLm1hcChyb3cgPT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcm93LnNwbGl0KCcsJykubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJpbW1lZCA9IHYudHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbnVtVmFsID0gcGFyc2VGbG9hdCh0cmltbWVkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihudW1WYWwpID8gdHJpbW1lZCA6IG51bVZhbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlU3RyLmluY2x1ZGVzKCcsJykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW3ZhbHVlU3RyLnNwbGl0KCcsJykubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmltbWVkID0gdi50cmltKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG51bVZhbCA9IHBhcnNlRmxvYXQodHJpbW1lZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihudW1WYWwpID8gdHJpbW1lZCA6IG51bVZhbDtcclxuICAgICAgICAgICAgICAgICAgICB9KV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gW1t2YWx1ZV1dO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgJ2t2Jzoge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XHJcbiAgICAgICAgICAgICAgICB2YWx1ZVN0ci5zcGxpdCgnLCcpLmZvckVhY2gocGFpciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW2tleSwgdmFsXSA9IHBhaXIuc3BsaXQoJzonKS5tYXAocyA9PiBzLnRyaW0oKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAmJiB2YWwgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBudW1WYWwgPSBwYXJzZUZsb2F0KHZhbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gaXNOYU4obnVtVmFsKSA/IHZhbCA6IG51bVZhbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIOi9rOaNouS4ulR5cGVTY3JpcHTnsbvlnotcclxuICAgIGNvbnN0IGNvbnZlcnRUb1RzVHlwZSA9ICh0eXBlOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xyXG4gICAgICAgIGlmICghdHlwZSkgcmV0dXJuICdhbnknO1xyXG4gICAgICAgIGNvbnN0IHR5cGVMb3dlciA9IHR5cGUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICBpZiAodHlwZUxvd2VyID09PSAnaW50JykgcmV0dXJuICdudW1iZXInO1xyXG4gICAgICAgIGlmICh0eXBlTG93ZXIgPT09ICdzdHJpbmcnKSByZXR1cm4gJ3N0cmluZyc7XHJcbiAgICAgICAgaWYgKHR5cGVMb3dlci5zdGFydHNXaXRoKCdhcnJheTEnKSkgcmV0dXJuICdhbnlbXSc7XHJcbiAgICAgICAgaWYgKHR5cGVMb3dlci5zdGFydHNXaXRoKCdhcnJheTInKSkgcmV0dXJuICdhbnlbXVtdJztcclxuICAgICAgICBpZiAodHlwZUxvd2VyLnN0YXJ0c1dpdGgoJ2t2JykpIHJldHVybiAneyBba2V5OiBzdHJpbmddOiBhbnkgfSc7XHJcbiAgICAgICAgcmV0dXJuICdhbnknO1xyXG4gICAgfTtcclxuXHJcbiAgICAvLyDlpITnkIbmr4/kuKpFeGNlbOaWh+S7tlxyXG4gICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcclxuICAgICAgICBpZiAoIS9cXC4oeGxzeHx4bHMpJC9pLnRlc3QocGF0aC5leHRuYW1lKGZpbGUpKSkgcmV0dXJuO1xyXG5cclxuICAgICAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGguam9pbihgJHtleGNlbFBhdGh9YCwgYCR7ZmlsZX1gKTtcclxuICAgICAgICBjb25zdCB3b3JrYm9vayA9IHhsc3gucmVhZEZpbGUoZmlsZVBhdGgpO1xyXG5cclxuICAgICAgICAvLyDlpITnkIbmr4/kuKrlt6XkvZzooahcclxuICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgd29ya2Jvb2suU2hlZXROYW1lcy5mb3JFYWNoKHNoZWV0TmFtZSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHdvcmtzaGVldCA9IHdvcmtib29rLlNoZWV0c1tzaGVldE5hbWVdO1xyXG4gICAgICAgICAgICBjb25zdCByb3dzOiBhbnlbXVtdID0geGxzeC51dGlscy5zaGVldF90b19qc29uKHdvcmtzaGVldCwgeyBoZWFkZXI6IDEgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXJvd3MgfHwgcm93cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybihg5bel5L2c6KGoICR7c2hlZXROYW1lfSDmsqHmnInmlbDmja7vvIzot7Pov4flpITnkIZgKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGpzb25EYXRhOiBhbnkgPSBudWxsO1xyXG4gICAgICAgICAgICBsZXQga2V5czogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgbGV0IHR5cGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgICAgICBsZXQgZmllbGRDb21tZW50czogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgIC8vIOWIpOaWreihqOagvOagvOW8j++8muerluW8j+aIluaoquW8j1xyXG4gICAgICAgICAgICBpZiAocm93c1swXVswXSA9PT0gJ2lkJyB8fCByb3dzWzBdWzBdID09PSAnbGlkJykge1xyXG4gICAgICAgICAgICAgICAgLy8g56uW5byP6KGo5qC8XHJcbiAgICAgICAgICAgICAgICBpZiAocm93cy5sZW5ndGggPCA0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGDlt6XkvZzooaggJHtzaGVldE5hbWV9IOaVsOaNruS4jei2s++8jOi3s+i/h+WkhOeQhmApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGtleXMgPSByb3dzWzBdO1xyXG4gICAgICAgICAgICAgICAgdHlwZXMgPSByb3dzWzFdLm1hcCgodDogYW55KSA9PiB0ID8gdC50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkgOiAnc3RyaW5nJyk7XHJcbiAgICAgICAgICAgICAgICBmaWVsZENvbW1lbnRzID0gcm93c1syXS5tYXAoKGM6IGFueSkgPT4gYyA/IGMudG9TdHJpbmcoKSA6ICcnKTtcclxuICAgICAgICAgICAgICAgIGpzb25EYXRhID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDM7IGkgPCByb3dzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm93ID0gcm93c1tpXTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmo6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocm93WzBdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBrZXlzLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmpba2V5c1tqXV0gPSBjb252ZXJ0VmFsdWUodHlwZXNbal0sIHJvd1tqXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAganNvbkRhdGEucHVzaChvYmopO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIOaoquW8j+ihqOagvFxyXG4gICAgICAgICAgICAgICAganNvbkRhdGEgPSB7fTtcclxuICAgICAgICAgICAgICAgIGtleXMgPSBbXTtcclxuICAgICAgICAgICAgICAgIHR5cGVzID0gW107XHJcbiAgICAgICAgICAgICAgICBmaWVsZENvbW1lbnRzID0gW107XHJcblxyXG4gICAgICAgICAgICAgICAgcm93cy5mb3JFYWNoKHJvdyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvdy5sZW5ndGggPCA0KSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gcm93WzBdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSByb3dbMV0gPyByb3dbMV0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpIDogJ3N0cmluZyc7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWVudCA9IHJvd1syXSA/IHJvd1syXS50b1N0cmluZygpIDogJyc7XHJcbiAgICAgICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZXMucHVzaCh0eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICBmaWVsZENvbW1lbnRzLnB1c2goY29tbWVudCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByb3cuc2xpY2UoMyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGpzb25EYXRhW2tleV0gPSBjb252ZXJ0VmFsdWUodHlwZSwgZGF0YVswXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAganNvbkRhdGFba2V5XSA9IGRhdGEubWFwKHYgPT4gY29udmVydFZhbHVlKHR5cGUsIHYpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g55Sf5oiQSlNPTuaWh+S7tlxyXG4gICAgICAgICAgICBjb25zdCBqc29uRmlsZU5hbWUgPSBgJHtzaGVldE5hbWV9Lmpzb25gO1xyXG4gICAgICAgICAgICBjb25zdCBqc29uT3V0cHV0RmlsZSA9IHBhdGguam9pbihgJHtvdXRwdXREaXJ9YCwgYCR7anNvbkZpbGVOYW1lfWApO1xyXG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGpzb25PdXRwdXRGaWxlLCBKU09OLnN0cmluZ2lmeShqc29uRGF0YSwgbnVsbCwgeWFzdW8gPyAwIDogMikpO1xyXG4gICAgICAgICAgICBnZW5lcmF0ZWRGaWxlcy5wdXNoKGpzb25PdXRwdXRGaWxlKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDovazmjaLmiJDlip86ICR7c2hlZXROYW1lfS5qc29uYCk7XHJcblxyXG4gICAgICAgICAgICAvLyDmlLbpm4bnsbvlnovkv6Hmga9cclxuICAgICAgICAgICAgdHlwZUluZm9zLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgbmFtZTogc2hlZXROYW1lLFxyXG4gICAgICAgICAgICAgICAgZmllbGRzOiBrZXlzLm1hcCgoa2V5LCBpbmRleCkgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgICBrZXksXHJcbiAgICAgICAgICAgICAgICAgICAgdHNUeXBlOiBjb252ZXJ0VG9Uc1R5cGUodHlwZXNbaW5kZXhdKSxcclxuICAgICAgICAgICAgICAgICAgICBjb21tZW50OiBmaWVsZENvbW1lbnRzW2luZGV4XSB8fCAnJ1xyXG4gICAgICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g55Sf5oiQ57G75Z6L5a6a5LmJ5paH5Lu2XHJcbiAgICBpZiAodHlwZUluZm9zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBnZW5lcmF0ZVR5cGVEZWZpbml0aW9uKHR5cGVJbmZvcyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIOeUn+aIkFR5cGVTY3JpcHTnsbvlnovlrprkuYnmlofku7ZcclxuZnVuY3Rpb24gZ2VuZXJhdGVUeXBlRGVmaW5pdGlvbihsaXN0OiBDb25maWdUeXBlSW5mb1tdKTogdm9pZCB7XHJcbiAgICBjb25zdCBsaW5lczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBsaW5lcy5wdXNoKFwiLy8g6Ieq5Yqo55Sf5oiQ55qE6YWN572u57G75Z6L5a6a5LmJ77yM6K+35Yu/5omL5Yqo5L+u5pS5XFxuXCIpO1xyXG4gICAgbGluZXMucHVzaChcIi8qKiDpgJrnlKjphY3nva7mn6Xor6LmjqXlj6MgKi9cIik7XHJcbiAgICBsaW5lcy5wdXNoKFwiaW50ZXJmYWNlIENvbmZpZ0Z1bmM8VD4ge1wiKTtcclxuICAgIGxpbmVzLnB1c2goXCIgICBnZXQodmFsdWU/OiBhbnksIGtleT86IHN0cmluZyk6IFQ7XCIpO1xyXG4gICAgbGluZXMucHVzaChcIiAgIGdldEFsbCgpOiBUW107XCIpO1xyXG4gICAgbGluZXMucHVzaChcIn1cXG5cIik7XHJcblxyXG4gICAgbGluZXMucHVzaChcImludGVyZmFjZSBjb25maWdUeXBlIHtcIik7XHJcbiAgICBsaXN0LmZvckVhY2goaW5mbyA9PiB7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gaW5mby5uYW1lLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpICsgaW5mby5uYW1lLnNsaWNlKDEpO1xyXG4gICAgICAgIGxpbmVzLnB1c2goYCAgICAke2tleX0/OiBDb25maWdGdW5jPCR7aW5mby5uYW1lfUNvbmZpZz47YCk7XHJcbiAgICB9KTtcclxuICAgIGxpbmVzLnB1c2goXCJ9XFxuXCIpO1xyXG5cclxuICAgIC8vIOeUn+aIkOavj+S4qumFjee9ruihqOeahOaOpeWPo1xyXG4gICAgbGlzdC5mb3JFYWNoKGluZm8gPT4ge1xyXG4gICAgICAgIGxpbmVzLnB1c2goYGludGVyZmFjZSAke2luZm8ubmFtZX1Db25maWcge2ApO1xyXG4gICAgICAgIGluZm8uZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZmllbGQuY29tbWVudCkge1xyXG4gICAgICAgICAgICAgICAgbGluZXMucHVzaChgICAgIC8qKiAke2ZpZWxkLmNvbW1lbnR9ICovYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGluZXMucHVzaChgICAgICR7ZmllbGQua2V5fT86ICR7ZmllbGQudHNUeXBlfTtgKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBsaW5lcy5wdXNoKFwifVxcblwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IG91dHB1dEZpbGUgPSBwYXRoLmpvaW4oRWRpdG9yLlByb2plY3QucGF0aCwgXCJ0eXBlX2NvbmYuZC50c1wiKTtcclxuICAgIGZzLndyaXRlRmlsZVN5bmMob3V0cHV0RmlsZSwgbGluZXMuam9pbihcIlxcblwiKSk7XHJcbiAgICBjb25zb2xlLmxvZyhcIuW3sueUn+aIkOexu+Wei+WumuS5ieaWh+S7tjogdHlwZV9jb25mLmQudHNcIik7XHJcbn0iXX0=