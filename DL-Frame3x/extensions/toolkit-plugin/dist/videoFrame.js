"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.videoToFrame = videoToFrame;
const fs = require("fs");
const path = require("path");
const ffmpeg = require("fluent-ffmpeg");
const floderName = "视频首帧图";
const outputPath = path.dirname(Editor.Project.path);
const outputDir = path.join(outputPath, floderName); // 输出文件夹路径
// 支持的视频格式
const SUPPORTED_VIDEO_FORMATS = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm'];
function videoToFrame(pathStr) {
    if (!(0, fs.existsSync)((0, path.join)(outputPath, floderName))) {
        (0, fs.mkdirSync)((0, path.join)(outputPath, floderName));
    }
    console.log(`开始处理目录: ${pathStr}`);
    // 检查ffmpeg是否可用
    checkFFmpegAvailability().then((available) => {
        if (!available) {
            console.error('FFmpeg 不可用，请确保已安装 FFmpeg 并添加到系统 PATH 中');
            return;
        }
        // 递归处理目录
        processDirectory(pathStr);
        console.log('提取完成，输出路径为: ' + outputDir);
    }).catch((error) => {
        console.error('检查 FFmpeg 可用性时出错: ' + error.message);
    });
}
;
// 检查 FFmpeg 是否可用
function checkFFmpegAvailability() {
    return new Promise((resolve) => {
        ffmpeg.getAvailableCodecs((err, codecs) => {
            if (err) {
                console.warn('FFmpeg 检查失败: ' + err.message);
                resolve(false);
            }
            else {
                console.log('FFmpeg 可用，开始处理视频文件');
                resolve(true);
            }
        });
    });
}
// 递归处理目录的函数
function processDirectory(dirPath) {
    try {
        // 读取目录中的所有文件和子目录
        const items = fs.readdirSync(dirPath);
        let processedCount = 0;
        const promises = [];
        items.forEach((item) => {
            const fullPath = path.join(dirPath, item);
            const stat = fs.statSync(fullPath);
            if (stat.isDirectory()) {
                // 如果是目录，递归处理
                processDirectory(fullPath);
            }
            else if (stat.isFile()) {
                // 如果是文件，检查是否为支持的视频文件
                const ext = path.extname(item).toLowerCase();
                if (SUPPORTED_VIDEO_FORMATS.includes(ext)) {
                    const promise = processImageFile(fullPath, dirPath, item);
                    promises.push(promise);
                    processedCount++;
                }
            }
        });
        // 等待所有处理完成
        Promise.all(promises).then(() => {
            if (processedCount > 0) {
                console.log(`目录 ${dirPath} 处理完成，共处理 ${processedCount} 个视频文件`);
            }
        }).catch((error) => {
            console.error(`处理目录 ${dirPath} 时出错: ${error.message}`);
        });
    }
    catch (error) {
        console.error(`读取目录 ${dirPath} 时出错: ${error.message}`);
    }
}
// 提取单个视频文件的首帧图
function processImageFile(filePath, dirPath, fileName) {
    return new Promise((resolve, reject) => {
        try {
            const videoName = path.basename(fileName, path.extname(fileName));
            // 创建相对路径的目录结构
            const outputImagePath = path.join(outputDir, `${videoName}_0.jpg`);
            // 如果图片已存在，跳过处理
            if (fs.existsSync(outputImagePath)) {
                console.log(`首帧图已存在，跳过: ${outputImagePath}`);
                resolve(fileName);
                return;
            }
            console.log(`正在提取首帧: ${fileName}`);
            // 使用 ffmpeg 提取视频第一帧
            ffmpeg(filePath)
                .screenshots({
                timestamps: ['0%'], // 提取第0秒的帧（第一帧）
                filename: `${videoName}_0.jpg`,
                folder: outputDir,
                size: '1024x1536' // 保持宽高比，最大尺寸 1920x1080
            })
                .on('end', () => {
                console.log(`成功提取首帧: ${outputImagePath}`);
                resolve(fileName);
            })
                .on('error', (err) => {
                console.error(`提取首帧失败 ${fileName}: ${err.message}`);
                reject(err);
            });
        }
        catch (error) {
            console.error(`处理视频文件 ${fileName} 时出错: ${error.message}`);
            reject(error);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW9GcmFtZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NvdXJjZS92aWRlb0ZyYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBV0Esb0NBa0JDO0FBN0JELE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBRXhDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQztBQUMzQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDckQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVO0FBRS9ELFVBQVU7QUFDVixNQUFNLHVCQUF1QixHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFFMUYsU0FBZ0IsWUFBWSxDQUFDLE9BQWU7SUFDeEMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUM5RCxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUVs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QUFHLFNBQVMsUUFBUTtnQkFDOUIsTUFBTSxFQUFFLFNBQVM7Z0JBQ2pCLElBQUksRUFBRSxXQUFXLENBQUMsdUJBQXVCO2FBQzVDLENBQUM7aUJBQ0QsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUU7Z0JBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLGVBQWUsRUFBRSxDQUFDLENBQUM7Z0JBQzFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUM7aUJBQ0QsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQVEsRUFBRSxFQUFFO2dCQUN0QixPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsUUFBUSxLQUFLLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2dCQUNwRCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFFWCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNsQixPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsUUFBUSxTQUFTLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQzFELE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgZmZtcGVnID0gcmVxdWlyZShcImZsdWVudC1mZm1wZWdcIik7XHJcblxyXG5jb25zdCBmbG9kZXJOYW1lID0gXCLop4bpopHpppbluKflm75cIjtcclxuY29uc3Qgb3V0cHV0UGF0aCA9IHBhdGguZGlybmFtZShFZGl0b3IuUHJvamVjdC5wYXRoKTtcclxuY29uc3Qgb3V0cHV0RGlyID0gcGF0aC5qb2luKG91dHB1dFBhdGgsIGZsb2Rlck5hbWUpOyAvLyDovpPlh7rmlofku7blpLnot6/lvoRcclxuXHJcbi8vIOaUr+aMgeeahOinhumikeagvOW8j1xyXG5jb25zdCBTVVBQT1JURURfVklERU9fRk9STUFUUyA9IFsnLm1wNCcsICcuYXZpJywgJy5tb3YnLCAnLm1rdicsICcud212JywgJy5mbHYnLCAnLndlYm0nXTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB2aWRlb1RvRnJhbWUocGF0aFN0cjogc3RyaW5nKSB7XHJcbiAgICBpZiAoISgwLCBmcy5leGlzdHNTeW5jKSgoMCwgcGF0aC5qb2luKShvdXRwdXRQYXRoLCBmbG9kZXJOYW1lKSkpIHtcclxuICAgICAgICAoMCwgZnMubWtkaXJTeW5jKSgoMCwgcGF0aC5qb2luKShvdXRwdXRQYXRoLCBmbG9kZXJOYW1lKSk7XHJcbiAgICB9XHJcbiAgICBjb25zb2xlLmxvZyhg5byA5aeL5aSE55CG55uu5b2VOiAke3BhdGhTdHJ9YCk7XHJcblxyXG4gICAgLy8g5qOA5p+lZmZtcGVn5piv5ZCm5Y+v55SoXHJcbiAgICBjaGVja0ZGbXBlZ0F2YWlsYWJpbGl0eSgpLnRoZW4oKGF2YWlsYWJsZSkgPT4ge1xyXG4gICAgICAgIGlmICghYXZhaWxhYmxlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZGbXBlZyDkuI3lj6/nlKjvvIzor7fnoa7kv53lt7Llronoo4UgRkZtcGVnIOW5tua3u+WKoOWIsOezu+e7nyBQQVRIIOS4rScpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOmAkuW9kuWkhOeQhuebruW9lVxyXG4gICAgICAgIHByb2Nlc3NEaXJlY3RvcnkocGF0aFN0cik7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ+aPkOWPluWujOaIkO+8jOi+k+WHuui3r+W+hOS4ujogJyArIG91dHB1dERpcik7XHJcbiAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCfmo4Dmn6UgRkZtcGVnIOWPr+eUqOaAp+aXtuWHuumUmTogJyArIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG4vLyDmo4Dmn6UgRkZtcGVnIOaYr+WQpuWPr+eUqFxyXG5mdW5jdGlvbiBjaGVja0ZGbXBlZ0F2YWlsYWJpbGl0eSgpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgIGZmbXBlZy5nZXRBdmFpbGFibGVDb2RlY3MoKGVycjogYW55LCBjb2RlY3M6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0ZGbXBlZyDmo4Dmn6XlpLHotKU6ICcgKyBlcnIubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGRm1wZWcg5Y+v55So77yM5byA5aeL5aSE55CG6KeG6aKR5paH5Lu2Jyk7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuLy8g6YCS5b2S5aSE55CG55uu5b2V55qE5Ye95pWwXHJcbmZ1bmN0aW9uIHByb2Nlc3NEaXJlY3RvcnkoZGlyUGF0aDogc3RyaW5nKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vIOivu+WPluebruW9leS4reeahOaJgOacieaWh+S7tuWSjOWtkOebruW9lVxyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gZnMucmVhZGRpclN5bmMoZGlyUGF0aCk7XHJcblxyXG4gICAgICAgIGxldCBwcm9jZXNzZWRDb3VudCA9IDA7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXM6IGFueVtdID0gW107XHJcblxyXG4gICAgICAgIGl0ZW1zLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGguam9pbihkaXJQYXRoLCBpdGVtKTtcclxuICAgICAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGZ1bGxQYXRoKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWmguaenOaYr+ebruW9le+8jOmAkuW9kuWkhOeQhlxyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc0RpcmVjdG9yeShmdWxsUGF0aCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdC5pc0ZpbGUoKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5aaC5p6c5piv5paH5Lu277yM5qOA5p+l5piv5ZCm5Li65pSv5oyB55qE6KeG6aKR5paH5Lu2XHJcbiAgICAgICAgICAgICAgICBjb25zdCBleHQgPSBwYXRoLmV4dG5hbWUoaXRlbSkudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgICAgIGlmIChTVVBQT1JURURfVklERU9fRk9STUFUUy5pbmNsdWRlcyhleHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHByb2Nlc3NJbWFnZUZpbGUoZnVsbFBhdGgsIGRpclBhdGgsIGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2gocHJvbWlzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkQ291bnQrKztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDnrYnlvoXmiYDmnInlpITnkIblrozmiJBcclxuICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChwcm9jZXNzZWRDb3VudCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDnm67lvZUgJHtkaXJQYXRofSDlpITnkIblrozmiJDvvIzlhbHlpITnkIYgJHtwcm9jZXNzZWRDb3VudH0g5Liq6KeG6aKR5paH5Lu2YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihg5aSE55CG55uu5b2VICR7ZGlyUGF0aH0g5pe25Ye66ZSZOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYOivu+WPluebruW9lSAke2RpclBhdGh9IOaXtuWHuumUmTogJHtlcnJvci5tZXNzYWdlfWApO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyDmj5Dlj5bljZXkuKrop4bpopHmlofku7bnmoTpppbluKflm75cclxuZnVuY3Rpb24gcHJvY2Vzc0ltYWdlRmlsZShmaWxlUGF0aDogc3RyaW5nLCBkaXJQYXRoOiBzdHJpbmcsIGZpbGVOYW1lOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgdmlkZW9OYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlTmFtZSwgcGF0aC5leHRuYW1lKGZpbGVOYW1lKSk7XHJcblxyXG4gICAgICAgICAgICAvLyDliJvlu7rnm7jlr7not6/lvoTnmoTnm67lvZXnu5PmnoRcclxuICAgICAgICAgICAgY29uc3Qgb3V0cHV0SW1hZ2VQYXRoID0gcGF0aC5qb2luKG91dHB1dERpciwgYCR7dmlkZW9OYW1lfV8wLmpwZ2ApO1xyXG5cclxuICAgICAgICAgICAgLy8g5aaC5p6c5Zu+54mH5bey5a2Y5Zyo77yM6Lez6L+H5aSE55CGXHJcbiAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKG91dHB1dEltYWdlUGF0aCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDpppbluKflm77lt7LlrZjlnKjvvIzot7Pov4c6ICR7b3V0cHV0SW1hZ2VQYXRofWApO1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShmaWxlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDmraPlnKjmj5Dlj5bpppbluKc6ICR7ZmlsZU5hbWV9YCk7XHJcblxyXG4gICAgICAgICAgICAvLyDkvb/nlKggZmZtcGVnIOaPkOWPluinhumikeesrOS4gOW4p1xyXG4gICAgICAgICAgICBmZm1wZWcoZmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAuc2NyZWVuc2hvdHMoe1xyXG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcHM6IFsnMCUnXSwgLy8g5o+Q5Y+W56ysMOenkueahOW4p++8iOesrOS4gOW4p++8iVxyXG4gICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiBgJHt2aWRlb05hbWV9XzAuanBnYCxcclxuICAgICAgICAgICAgICAgICAgICBmb2xkZXI6IG91dHB1dERpcixcclxuICAgICAgICAgICAgICAgICAgICBzaXplOiAnMTAyNHgxNTM2JyAvLyDkv53mjIHlrr3pq5jmr5TvvIzmnIDlpKflsLrlr7ggMTkyMHgxMDgwXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLm9uKCdlbmQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYOaIkOWKn+aPkOWPlummluW4pzogJHtvdXRwdXRJbWFnZVBhdGh9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShmaWxlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLm9uKCdlcnJvcicsIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYOaPkOWPlummluW4p+Wksei0pSAke2ZpbGVOYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYOWkhOeQhuinhumikeaWh+S7tiAke2ZpbGVOYW1lfSDml7blh7rplJk6ICR7ZXJyb3IubWVzc2FnZX1gKTtcclxuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG4iXX0=